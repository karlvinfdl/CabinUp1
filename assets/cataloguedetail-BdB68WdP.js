let h=[],m=[],f=1,l,g;function w(){if(!(!r("#map")||typeof L>"u")){if(l){console.warn("Carte du catalogue d√©j√† initialis√©e");return}l=L.map("map",{zoomControl:!0}).setView([46.5,2],6),L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | <a href="https://carto.com/">CARTO</a>',subdomains:"abcd",maxZoom:20}).addTo(l),g=L.layerGroup().addTo(l),setTimeout(()=>l.invalidateSize(),300)}}function S(){if(!l||!g)return;g.clearLayers();const n=m.filter(e=>e.style.display!=="none"),t=[];n.forEach(e=>{const a=parseFloat(e.dataset.lat),i=parseFloat(e.dataset.lng);if(isNaN(a)||isNaN(i))return;const s=e.dataset.prix||"",c=e.dataset.ville||"",v=e.querySelector("img")?.src||"";L.marker([a,i],{icon:L.divIcon({className:"price-marker",html:`${s}‚Ç¨`,iconSize:null,iconAnchor:[30,20]})}).addTo(g).bindPopup(`
      <div style="text-align:center;width:230px">
        ${v?`<img src="${v}" alt="${c}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:6px">`:""}
        <strong style="font-size:16px">${c}</strong><br>
        <span style="font-weight:bold;color:#2f6f3f;font-size:16px">${s} ‚Ç¨ / nuit</span>
      </div>
    `),t.push([a,i])}),t.length>0?l.fitBounds(t,{padding:[50,50]}):l.setView([46.5,2],6)}function _(n){const t=r("#pagination");if(!t)return;t.innerHTML="";const e=Math.max(1,Math.ceil(n/6));for(let a=1;a<=e;a++){const i=document.createElement("button");i.textContent=a,a===f&&i.classList.add("active"),i.addEventListener("click",()=>{f=a,E()}),t.appendChild(i)}}function E(){const n=(f-1)*6,t=n+6;m.forEach((e,a)=>{e.style.display=a>=n&&a<t?"":"none"}),_(m.length),S()}function $(){const n=(r("#dest-desktop")?.value||"").trim().toLowerCase();m=n?h.filter(t=>{const e=(t.dataset.ville||"").toLowerCase(),a=(t.querySelector("h3")?.textContent||"").toLowerCase();return e.includes(n)||a.includes(n)}):[...h],f=1,E()}document.addEventListener("DOMContentLoaded",()=>{const n=r("#cardsContainer");n&&fetch("https://karlvinfdl.github.io/CabinUp1/data/logements.json").then(t=>{if(!t.ok)throw new Error("Erreur serveur");return t.json()}).then(t=>{n.innerHTML=t.map(e=>`
        <a href="../pages/detail.html?id=${e.id}" class="card"
           data-lat="${e.lat}" data-lng="${e.lng}"
           data-ville="${e.ville}" data-prix="${e.prix}">
          <img src="${e.image||"../assets/images/placeholder.jpg"}" alt="${e.titre}">
          <div class="card-body">
            <div class="card-content">
              <h3>${e.titre}</h3>
              <p>${e.ville} ‚Ä¢ ${e.capacite||1} personne${(e.capacite||1)>1?"s":""}</p>
              <span class="available">
                ${typeof e.disponibilite=="number"?`${e.disponibilite} logement(s) dispo`:e.disponibilite||""}
              </span>
            </div>
            <p class="price">${e.prix} ‚Ç¨/nuit</p>
          </div>
        </a>
      `).join(""),h=$$(".card",n),m=[...h],r("#search-btn")?.addEventListener("click",$),r("#dest-desktop")?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),$())}),w(),E()}).catch(t=>{console.error("‚ùå Erreur lors du chargement du JSON :",t),n.innerHTML="<p style='color:red;'>Impossible de charger les logements üò¢</p>"})});const r=(n,t=document)=>t.querySelector(n),x=new URLSearchParams(window.location.search).get("id");x?fetch("https://karlvinfdl.github.io/CabinUp1/data/logements.json").then(t=>{if(!t.ok)throw new Error(`Erreur ${t.status} : logement non trouv√©`);return t.json()}).then(t=>{const e=t.find(o=>o.id==x);if(!e)throw new Error("Aucun logement correspondant trouv√©.");const a=r("#product-image"),i=e.image?.replace(/^(\.\.\/)+/,"../")||"../assets/images/placeholder.jpg";a.src=i,a.alt=e.titre;const s=document.querySelector(".thumbs__detail"),c=document.querySelector("#lightbox-slides");s.innerHTML="",c.innerHTML="",[i,...(e.galerie||[]).map(o=>o.replace(/^(\.\.\/)+/,"../"))].forEach((o,d)=>{if(d>0){const u=document.createElement("div");u.className="thumb__detail",u.innerHTML=`<img src="${o}" alt="${e.titre}">`,u.addEventListener("click",()=>a.src=o),s.appendChild(u)}const p=document.createElement("img");p.src=o,p.alt=e.titre,c.appendChild(p)}),r("#product-title").textContent=e.titre,r("#product-desc p").textContent=e.description,r("#product-price").innerHTML=`${e.prix} ‚Ç¨ <span class="muted__detail">/ nuit</span>`,r(".meta__detail").innerHTML=`<span>${e.ville}</span> ‚Ä¢ <span>${e.capacite} pers.</span>`;const y=r(".amen-grid__detail");y.innerHTML=(e.equipements||[]).map(o=>`<div class="amen__detail"><i class="fa-solid fa-check"></i><span>${o}</span></div>`).join(""),C(e.lat,e.lng,12,`${e.titre} ‚Äî ${e.ville}`),r("#add-to-cart").addEventListener("click",o=>{o.preventDefault();let d=JSON.parse(localStorage.getItem("cart"))||[];if(d.find(p=>p.id===e.id)){alert("‚ö†Ô∏è Ce logement est d√©j√† dans votre panier !");return}d.push({id:e.id,titre:e.titre,ville:e.ville,prix:e.prix,description:e.description,capacite:e.capacite,image:i,galerie:e.galerie,lat:e.lat,lng:e.lng,nights:1,guests:1}),localStorage.setItem("cart",JSON.stringify(d)),alert("‚úÖ Logement ajout√© au panier !")})}).catch(t=>{console.error("Erreur lors du chargement du logement :",t),document.body.innerHTML=`<h2 style="color:red;text-align:center;">‚ö†Ô∏è ${t.message}</h2>`}):console.error("‚ùå ID manquant dans l'URL.");function C(n=45.75,t=4.85,e=12,a="Emplacement du logement"){const i=document.getElementById("map");if(!i||typeof L>"u"){console.warn("‚ö†Ô∏è Leaflet non charg√© ou #map introuvable");return}if(i._leaflet_id){console.log("‚úÖ Carte d√©j√† initialis√©e, on ne la recr√©e pas.");return}const s=L.map(i).setView([n,t],e);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(s),L.marker([n,t]).addTo(s).bindPopup(`<b>${a}</b>`).openPopup()}window.initMapDetail=C;const b=document.getElementById("toggleAmenities");b&&b.addEventListener("click",()=>{const n=document.getElementById("moreAmenities");n.classList.toggle("hidden__detail"),b.textContent=n.classList.contains("hidden__detail")?"Voir plus":"Voir moins"});
