let h=[],p=[],f=1,c,g;function w(){if(!(!r("#map")||typeof L>"u")){if(c){console.warn("Carte du catalogue d√©j√† initialis√©e");return}c=L.map("map",{zoomControl:!0}).setView([46.5,2],6),L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | <a href="https://carto.com/">CARTO</a>',subdomains:"abcd",maxZoom:20}).addTo(c),g=L.layerGroup().addTo(c),setTimeout(()=>c.invalidateSize(),300)}}function C(){if(!c||!g)return;g.clearLayers();const n=p.filter(t=>t.style.display!=="none"),e=[];n.forEach(t=>{const a=parseFloat(t.dataset.lat),i=parseFloat(t.dataset.lng);if(isNaN(a)||isNaN(i))return;const s=t.dataset.prix||"",v=t.dataset.ville||"",m=t.querySelector("img")?.src||"";L.marker([a,i],{icon:L.divIcon({className:"price-marker",html:`${s}‚Ç¨`,iconSize:null,iconAnchor:[30,20]})}).addTo(g).bindPopup(`
      <div style="text-align:center;width:230px">
        ${m?`<img src="${m}" alt="${v}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:6px">`:""}
        <strong style="font-size:16px">${v}</strong><br>
        <span style="font-weight:bold;color:#2f6f3f;font-size:16px">${s} ‚Ç¨ / nuit</span>
      </div>
    `),e.push([a,i])}),e.length>0?c.fitBounds(e,{padding:[50,50]}):c.setView([46.5,2],6)}function S(n){const e=r("#pagination");if(!e)return;e.innerHTML="";const t=Math.max(1,Math.ceil(n/6));for(let a=1;a<=t;a++){const i=document.createElement("button");i.textContent=a,a===f&&i.classList.add("active"),i.addEventListener("click",()=>{f=a,y()}),e.appendChild(i)}}function y(){const n=(f-1)*6,e=n+6;p.forEach((t,a)=>{t.style.display=a>=n&&a<e?"":"none"}),S(p.length),C()}function b(){const n=(r("#dest-desktop")?.value||"").trim().toLowerCase();p=n?h.filter(e=>{const t=(e.dataset.ville||"").toLowerCase(),a=(e.querySelector("h3")?.textContent||"").toLowerCase();return t.includes(n)||a.includes(n)}):[...h],f=1,y()}document.addEventListener("DOMContentLoaded",()=>{const n=r("#cardsContainer");n&&fetch("http://localhost:3001/logements").then(e=>{if(!e.ok)throw new Error("Erreur serveur");return e.json()}).then(e=>{n.innerHTML=e.map(t=>`
        <a href="../pages/detail.html?id=${t.id}" class="card"
           data-lat="${t.lat}" data-lng="${t.lng}"
           data-ville="${t.ville}" data-prix="${t.prix}">
          <img src="${t.image||"../assets/images/placeholder.jpg"}" alt="${t.titre}">
          <div class="card-body">
            <div class="card-content">
              <h3>${t.titre}</h3>
              <p>${t.ville} ‚Ä¢ ${t.capacite||1} personne${(t.capacite||1)>1?"s":""}</p>
              <span class="available">
                ${typeof t.disponibilite=="number"?`${t.disponibilite} logement(s) dispo`:t.disponibilite||""}
              </span>
            </div>
            <p class="price">${t.prix} ‚Ç¨/nuit</p>
          </div>
        </a>
      `).join(""),h=$$(".card",n),p=[...h],r("#search-btn")?.addEventListener("click",b),r("#dest-desktop")?.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),b())}),w(),y()}).catch(e=>{console.error("‚ùå Erreur lors du chargement du JSON :",e),n.innerHTML="<p style='color:red;'>Impossible de charger les logements üò¢</p>"})});const r=(n,e=document)=>e.querySelector(n),$=new URLSearchParams(window.location.search).get("id");$?fetch(`http://localhost:3001/logements/${$}`).then(e=>{if(!e.ok)throw new Error(`Erreur ${e.status} : logement non trouv√©`);return e.json()}).then(e=>{if(!e||!e.id)throw new Error("Aucun logement correspondant trouv√©.");const t=r("#product-image"),a=e.image?.replace(/^(\.\.\/)+/,"../")||"../assets/images/placeholder.jpg";t.src=a,t.alt=e.titre;const i=document.querySelector(".thumbs__detail"),s=document.querySelector("#lightbox-slides");i.innerHTML="",s.innerHTML="",[a,...(e.galerie||[]).map(o=>o.replace(/^(\.\.\/)+/,"../"))].forEach((o,l)=>{if(l>0){const u=document.createElement("div");u.className="thumb__detail",u.innerHTML=`<img src="${o}" alt="${e.titre}">`,u.addEventListener("click",()=>t.src=o),i.appendChild(u)}const d=document.createElement("img");d.src=o,d.alt=e.titre,s.appendChild(d)}),r("#product-title").textContent=e.titre,r("#product-desc p").textContent=e.description,r("#product-price").innerHTML=`${e.prix} ‚Ç¨ <span class="muted__detail">/ nuit</span>`,r(".meta__detail").innerHTML=`<span>${e.ville}</span> ‚Ä¢ <span>${e.capacite} pers.</span>`;const m=r(".amen-grid__detail");m.innerHTML=(e.equipements||[]).map(o=>`<div class="amen__detail"><i class="fa-solid fa-check"></i><span>${o}</span></div>`).join(""),x(e.lat,e.lng,12,`${e.titre} ‚Äî ${e.ville}`),r("#add-to-cart").addEventListener("click",o=>{o.preventDefault();let l=JSON.parse(localStorage.getItem("cart"))||[];if(l.find(d=>d.id===e.id)){alert("‚ö†Ô∏è Ce logement est d√©j√† dans votre panier !");return}l.push({id:e.id,titre:e.titre,ville:e.ville,prix:e.prix,description:e.description,capacite:e.capacite,image:a,galerie:e.galerie,lat:e.lat,lng:e.lng,nights:1,guests:1}),localStorage.setItem("cart",JSON.stringify(l)),alert("‚úÖ Logement ajout√© au panier !")})}).catch(e=>{console.error("Erreur lors du chargement du logement :",e),document.body.innerHTML=`<h2 style="color:red;text-align:center;">‚ö†Ô∏è ${e.message}</h2>`}):console.error("‚ùå ID manquant dans l'URL.");function x(n=45.75,e=4.85,t=12,a="Emplacement du logement"){const i=document.getElementById("map");if(!i||typeof L>"u"){console.warn("‚ö†Ô∏è Leaflet non charg√© ou #map introuvable");return}if(i._leaflet_id){console.log("‚úÖ Carte d√©j√† initialis√©e, on ne la recr√©e pas.");return}const s=L.map(i).setView([n,e],t);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(s),L.marker([n,e]).addTo(s).bindPopup(`<b>${a}</b>`).openPopup()}window.initMapDetail=x;const E=document.getElementById("toggleAmenities");E&&E.addEventListener("click",()=>{const n=document.getElementById("moreAmenities");n.classList.toggle("hidden__detail"),E.textContent=n.classList.contains("hidden__detail")?"Voir plus":"Voir moins"});
